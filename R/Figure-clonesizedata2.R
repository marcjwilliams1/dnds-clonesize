library(brms)
library(tidyverse)
library(jcolors)
library(argparse)
library(tidybayes)
library(bayesplot)
library(modelr)
library(cowplot)

modelfits <- readRDS(snakemake@input$datafits)

message("Perform some model selection")
waicdf <- data.frame(waic = c(modelfits$frechet$waic$estimates[3],
                              modelfits$lognormal$waic$estimates[3],
                              modelfits$normal$waic$estimates[3]),
                     waicse = c(modelfits$frechet$waic$estimates[3,2],
                                modelfits$lognormal$waic$estimates[3,2],
                                modelfits$normal$waic$estimates[3,2]),
                     R2 = c(mean(modelfits$frechet$R2),
                            mean(modelfits$lognormal$R2),
                            mean(modelfits$normal$R2)),
                     R2min = c(quantile(modelfits$frechet$R2, 0.025),
                               quantile(modelfits$lognormal$R2, 0.025),
                               quantile(modelfits$normal$R2, 0.025)),
                     R2max = c(quantile(modelfits$frechet$R2, 0.975),
                               quantile(modelfits$lognormal$R2, 0.975),
                               quantile(modelfits$normal$R2, 0.975)),
                     model = c("Frechet", "Log Normal", "Normal"),
                     ord = c(1,2,3))

gwaic <- waicdf %>%
  filter(model != "Frechet") %>%
  mutate(ymin = waic - 2*waicse, ymax = waic + 2*waicse) %>%
  ggplot(aes(x = fct_reorder(model, ord), y = waic, ymin = ymin, ymax = ymax)) +
  geom_point() +
  geom_linerange() +
  xlab("") +
  ylab("WAIC") +
  theme_cowplot() +
  coord_flip()

(ppcheckfrech <- plot(pp_check(modelfits$frechet, nsamples = 50)) +
    scale_x_log10(limits = c(1e-3, 1e1)) +
     theme_cowplot() +
    xlab("Area") +
    ylab("Density"))

(ppchecknormal <- plot(pp_check(modelfits$normal, nsamples = 50)) +
    scale_x_log10(limits = c(1e-3, 1e1)) +
    theme_cowplot() +
    xlab("Area") +
    ylab("Density"))

(ppchecklognormal <- plot(pp_check(modelfits$lognormal, nsamples = 50)) +
    scale_x_log10(limits = c(1e-3, 1e1)) +
    theme_cowplot() +
    xlab("Area") +
    ylab("Density"))

ppcheck <- ppchecklognormal

(g <- plot_grid(ppcheckfrech + ggtitle("Frechet"),
          ppchecklognormal + ggtitle("Log normal"),
          ppchecknormal + ggtitle("Normal"), ncol = 3))
save_plot(snakemake@output$suppfigure[2], g, base_aspect_ratio = 4.0)


frechetCoef <- modelfits$lognormal %>%
  spread_draws(r_gene1[gene, var], b_Age2) %>%
  filter(var == "Age2") %>%
  median_qi(coef = r_gene1 + b_Age2) %>%
  arrange(desc(coef))

(gsummary <- frechetCoef %>%
  ggplot(aes(x = fct_reorder(gene, coef, .desc = TRUE), y = coef,
             xmin = .lower, xmax = .upper)) +
  geom_pointinterval() +
  xlab("") +
  ylab("Regression coefficient") +
  geom_hline(yintercept = 0.0, lty = 2, col = "firebrick") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)))


dfg <- read_csv(snakemake@input$oesophagusfitmissense)
DFresults <- dfg %>%
  group_by(gene, deltafit, nmutations, deltafitlq, deltafituq) %>%
  summarise(rsq = first(rsq)) %>%
  filter(rsq > 0.6, nmutations > 7) %>%
  group_by(gene) %>% mutate(n = n()) %>%
  summarise(deltafit = mean(deltafit))

(gcompare <- left_join(DFresults, frechetCoef) %>%
  ggplot(aes(x = deltafit, y = coef)) +
  geom_text(aes(label = gene)) +
  #scale_y_log10() +
  #scale_x_log10() +
  geom_smooth(method = "lm", se = F) +
  xlab(expression(Delta~" fit - dN/dS")) +
  ylab("Regression coefficient") +
  theme_cowplot())

forlm <- left_join(DFresults, frechetCoef)
print(summary(lm(deltafit ~ coef, data = forlm)))
print(summary(lm(log(deltafit) ~ log(coef), data = forlm)))
print("Correlation")
print(cor(forlm$deltafit, forlm$coef))
print("Correlation (logged)")
print(cor(log(forlm$deltafit), log(forlm$coef)))

message("Generate final figure")
g <- plot_grid(gwaic, ppcheck + theme(legend.position = c(0.7, 0.9)),
               gcompare, ncol = 3, labels = c("a", "b", "c"), align = "h")
gall <- plot_grid(gsummary, gcompare, ncol = 2, labels = c("a", "b"), rel_widths = c(1.0, 0.3))
save_plot(snakemake@output$suppfigures[1], gall, base_height = 5, base_width = 20)

message("Linear regression")
dat <- left_join(DFresults, frechetCoef)
print(summary(lm(deltafit ~ coef, dat)))
cor(dat$deltafit, dat$coef)
